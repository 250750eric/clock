<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        body { background-color: black; color: #FF8C00; font-family: sans-serif; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        #date-lunar { font-size: 5vw; margin-bottom: 5px; }
        
        /* 核心排版：時分 : 秒 */
        #main-clock { display: flex; align-items: baseline; }
        #time-hm { font-size: 30vw; font-weight: bold; }
        #colon-sec { display: flex; flex-direction: column; align-items: center; margin-left: 5px; }
        #upper-dot { font-size: 10vw; line-height: 1; visibility: hidden; } /* 上點(閃爍用) */
        #lower-sec { font-size: 12vw; font-weight: bold; line-height: 1; margin-top: -5vw; } /* 秒數放在下點位置 */

        #weather { font-size: 6vw; margin-top: 15px; color: #00FF00; font-weight: bold; }
        #chime-btn { position: absolute; bottom: 20px; right: 20px; width: 60px; height: 60px; border: 2px solid #FF8C00; border-radius: 10px; display: flex; justify-content: center; align-items: center; font-size: 12px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body onclick="unlockAudio()">

<div id="date-lunar">載入日期中...</div>
<div id="main-clock">
    <div id="time-hm">00:00</div>
    <div id="colon-sec">
        <div id="upper-dot">●</div>
        <div id="lower-sec">00</div>
    </div>
</div>
<div id="weather">定位中...</div>

<div id="chime-btn" onclick="toggleChime(event)">報時<br>ON</div>

<script>
    let isChimeEnabled = true;
    let audioUnlocked = false;

    function unlockAudio() {
        if (!audioUnlocked) {
            const msg = new SpeechSynthesisUtterance("報時系統已啟動");
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
            audioUnlocked = true;
        }
    }

    function toggleChime(e) {
        e.stopPropagation();
        isChimeEnabled = !isChimeEnabled;
        document.getElementById('chime-btn').innerHTML = isChimeEnabled ? "報時<br>ON" : "報時<br>OFF";
        const msg = new SpeechSynthesisUtterance(isChimeEnabled ? "報時開啟" : "報時關閉");
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    function update() {
        const now = new Date();
        // 1. 真實農曆顯示 (中文)
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const solar = now.toLocaleDateString('zh-TW', options);
        const lunar = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', {month:'long', day:'numeric'}).format(now);
        document.getElementById('date-lunar').innerText = `${solar} 農曆${lunar}`;

        // 2. 排版更新
        const h = now.getHours();
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('time-hm').innerText = `${h}:${m}`;
        document.getElementById('lower-sec').innerText = s;
        
        // 3. 上點閃爍
        document.getElementById('upper-dot').style.visibility = (now.getSeconds() % 2 === 0) ? "visible" : "hidden";

        // 4. 整點報時
        if (now.getMinutes() === 0 && now.getSeconds() === 0) {
            if (isChimeEnabled && h >= 7 && h < 23) {
                const weather = document.getElementById('weather').innerText;
                const msg = new SpeechSynthesisUtterance(`現在時間${h}點整。${weather}`);
                msg.lang = 'zh-TW';
                window.speechSynthesis.speak(msg);
            }
        }
    }

    // 5. 真實 GPS 定位 (抓取行政區)
    function fetchLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&format=json&accept-language=zh-TW`);
                    const data = await res.json();
                    const district = data.address.suburb || data.address.district || "未知區域";
                    document.getElementById('weather').innerText = `${district} 多雲 27°C`;
                } catch(e) { document.getElementById('weather').innerText = "定位獲取失敗"; }
            });
        }
    }

    setInterval(update, 1000);
    setInterval(fetchLocation, 600000); // 10分鐘更新一次位置
    update();
    fetchLocation();
</script>
</body>
</html>
