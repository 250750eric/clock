<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Clock Final Pro</title>
    <style>
        :root { --bg-color: #000; --main-color: #fff; --accent-color: #00e5ff; --weather-color: #00ff41; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--main-color); font-family: sans-serif; overflow: hidden; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: color 0.3s ease; }
        #top-info-area { font-size: 4vh; margin-bottom: 2vh; cursor: pointer; text-align: center; }
        #clock-container { display: flex; align-items: center; font-weight: bold; line-height: 0.9; }
        .time-num { font-size: 42vh; }
        #colon-box { width: 10vh; height: 32vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        @media (orientation: portrait) { 
            .time-num { font-size: 28vw; } 
            #top-info-area { font-size: 5vw; margin-top: -5vh; } 
            #weather-row { font-size: 6.5vw !important; flex-direction: column; align-items: center; gap: 10px !important; } 
            #colon-box { width: 11vw; } 
            #seconds { font-size: 9vw !important; } 
        }

        .dot { width: 1.8vh; height: 1.8vh; background-color: currentColor; border-radius: 50%; }
        #dot-top { margin-bottom: 6vh; }
        #seconds { font-size: 9vh; opacity: 0.6; margin-top: 1.5vh; font-family: monospace; }
        #weather-row { display: flex; gap: 15px; font-size: 5.5vh; margin-top: 3vh; font-weight: bold; }
        #city { color: var(--accent-color); }
        #weather-detail { color: var(--weather-color); }
        #voice-toggle { position: absolute; right: 5vw; bottom: 5vh; width: 75px; height: 75px; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; background: rgba(255,255,255,0.05); cursor: pointer; border-radius: 12px; }
        #toggle-status { font-size: 24px; color: #ff9800; }
        #toggle-label { font-size: 14px; color: #888; }
        .blink { visibility: hidden; }
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.98); display: flex; justify-content: center; align-items: center; z-index: 9999; color: #fff; text-align: center; font-size: 24px; }
    </style>
</head>
<body onclick="unlockAudio()">

    <div id="overlay">【 點擊解鎖功能 】</div>

    <div id="top-info-area" onclick="changeThemeColor(event)">
        <div id="date-str"></div>
        <div id="lunar-str"></div>
    </div>

    <div id="clock-container">
        <div class="time-num" id="hh">00</div>
        <div id="colon-box">
            <div class="dot" id="dot-top"></div>
            <div id="seconds">00</div>
        </div>
        <div class="time-num" id="mm">00</div>
    </div>

    <div id="weather-row">
        <div id="city">定位中...</div>
        <div id="weather-detail">更新中...</div>
    </div>

    <div id="voice-toggle" onclick="toggleVoice(event)">
        <div id="toggle-status">開</div>
        <div id="toggle-label">語音</div>
    </div>

    <script>
        let voiceEnabled = true;
        let colorIdx = 0;
        const themes = ['#FFFFFF', '#00FF41', '#00E5FF', '#FF9800', '#FF4081'];
        const synth = window.speechSynthesis;
        let lastHour = -1;

        function unlockAudio() {
            document.getElementById('overlay').style.display = 'none';
            const msg = new SpeechSynthesisUtterance("");
            synth.speak(msg);
            setTimeout(() => { speak("系統就緒"); }, 200);
            initLocation();
        }

        function speak(text) {
            if (!voiceEnabled || !text) return;
            synth.cancel();
            const u = new SpeechSynthesisUtterance(text);
            u.lang = 'zh-TW';
            synth.speak(u);
        }

        function changeThemeColor(e) {
            e.stopPropagation();
            colorIdx = (colorIdx + 1) % themes.length;
            document.body.style.setProperty('--main-color', themes[colorIdx]);
            speak("切換顏色");
        }

        function toggleVoice(e) {
            e.stopPropagation();
            voiceEnabled = !voiceEnabled;
            document.getElementById('toggle-status').innerText = voiceEnabled ? "開" : "關";
            document.getElementById('toggle-status').style.color = voiceEnabled ? "#ff9800" : "#555";
        }

        // 自動農曆換日邏輯
        function getLunarText(date) {
            const formatter = new Intl.DateTimeFormat('zh-u-ca-chinese', {day:'numeric', month:'long'});
            let parts = formatter.format(date);
            const chnNum = ["", "一", "二", "三", "四", "五", "六", "七", "八", "九", "十"];
            let lunar = parts.replace(/\d+/, (n) => {
                let num = parseInt(n);
                if (num <= 10) return "初" + chnNum[num];
                if (num < 20) return "十" + chnNum[num % 10];
                if (num === 20) return "二十";
                return "廿" + chnNum[num % 10];
            });
            return "農曆 " + lunar;
        }

        async function initLocation() {
            // 優先嘗試 IP 定位獲取座標，再轉換為中文地址
            try {
                const ipRes = await fetch('https://ipapi.co/json/');
                const ipData = await ipRes.json();
                updateWeather(ipData.latitude, ipData.longitude);
            } catch (e) {
                // 若失敗則嘗試 GPS
                navigator.geolocation.getCurrentPosition(
                    p => updateWeather(p.coords.latitude, p.coords.longitude),
                    err => { document.getElementById('city').innerText = "台中市 北區"; }
                );
            }
        }

        async function updateWeather(lat, lon) {
            try {
                // 1. 獲取中文詳細地名 (台中市 北區)
                const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`);
                const geoData = await geoRes.json();
                const cityStr = (geoData.city || "") + " " + (geoData.locality || "");
                document.getElementById('city').innerText = cityStr || "台中市 北區";

                // 2. 獲取天氣數據
                const wRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code&timezone=auto`);
                const wData = await wRes.json();
                const weatherMap = {0:"晴朗", 1:"晴", 2:"多雲", 3:"陰天", 45:"霧", 61:"小雨", 95:"雷雨"};
                const desc = weatherMap[wData.current.weather_code] || "多雲";
                document.getElementById('weather-detail').innerText = `${desc} ${Math.round(wData.current.temperature_2m)}°C / 濕度 ${wData.current.relative_humidity_2m}%`;
            } catch (e) { console.error(e); }
        }

        function tick() {
            const now = new Date();
            const hh = now.getHours();
            const mm = now.getMinutes();
            const ss = now.getSeconds();

            document.getElementById('hh').innerText = String(hh).padStart(2, '0');
            document.getElementById('mm').innerText = String(mm).padStart(2, '0');
            document.getElementById('seconds').innerText = String(ss).padStart(2, '0');
            document.getElementById('dot-top').classList.toggle('blink');

            // 修正日期 (移除星期後的日字)
            const weekDays = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];
            document.getElementById('date-str').innerText = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 ${weekDays[now.getDay()]}`;
            document.getElementById('lunar-str').innerText = getLunarText(now);
            
            if (mm === 0 && ss === 0 && hh !== lastHour) {
                speak(`現在時間${hh}點整`);
                lastHour = hh;
                initLocation();
            }
        }

        setInterval(tick, 1000);
        tick();
    </script>
</body>
</html>
