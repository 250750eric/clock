<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS 氣象鐘</title>
    <style>
        body {
            background-color: black;
            color: #FF8C00; /* 您最愛的亮橘色 */
            font-family: Arial, sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            transition: color 0.3s;
        }

        /* 時間顯示區 */
        #clock-container {
            position: relative;
            text-align: center;
        }
        #date-lunar { font-size: 5vw; margin-bottom: 2vh; }
        #time { font-size: 25vw; font-weight: bold; line-height: 1; }
        #weather { font-size: 6vw; margin-top: 2vh; color: #00FF00; } /* 綠色氣象資訊 */

        /* 報時按鈕 (方型) */
        #chime-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: rgba(255, 140, 0, 0.2);
            border: 2px solid #FF8C00;
            border-radius: 8px; /* 方型略帶圓角 */
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 100;
        }
        #chime-btn.active { background: rgba(255, 140, 0, 0.8); color: black; }
        #chime-btn span { font-size: 12px; font-weight: bold; text-align: center; }
    </style>
</head>
<body onclick="enableAudio()">

    <div id="clock-container">
        <div id="date-lunar">載入中...</div>
        <div id="time">00:00</div>
        <div id="weather">台中 定位中...</div>
    </div>

    <div id="chime-btn" onclick="toggleChime(event)">
        <span id="chime-status">報時<br>ON</span>
    </div>

    <script>
        let isChimeEnabled = true;
        let lastAnnouncedHour = -1;
        let audioContext;

        // 初始化音訊 (Android 需使用者點擊觸發)
        function enableAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function toggleChime(e) {
            e.stopPropagation();
            isChimeEnabled = !isChimeEnabled;
            const btn = document.getElementById('chime-btn');
            const status = document.getElementById('chime-status');
            if (isChimeEnabled) {
                btn.classList.add('active');
                status.innerHTML = "報時<br>ON";
                testVoice(); // 點擊時測試一下
            } else {
                btn.classList.remove('active');
                status.innerHTML = "報時<br>OFF";
            }
        }

        function testVoice() {
            const msg = new SpeechSynthesisUtterance("報時功能已開啟");
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
        }

        // 報時核心邏輯
        function announceTime(hour) {
            if (!isChimeEnabled || hour === lastAnnouncedHour) return;
            
            // 深夜模式 (23:00 - 07:00 不報時)
            if (hour >= 23 || hour < 7) return;

            // 1. 叮一聲
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain); gain.connect(audioContext.destination);
            osc.frequency.setValueAtTime(880, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
            osc.start(); osc.stop(audioContext.currentTime + 0.5);

            // 2. 語音報時
            setTimeout(() => {
                const weatherInfo = document.getElementById('weather').innerText;
                const msg = new SpeechSynthesisUtterance(`現在時間${hour}點整。${weatherInfo}`);
                msg.lang = 'zh-TW';
                window.speechSynthesis.speak(msg);
            }, 1000);

            lastAnnouncedHour = hour;
        }

        function updateClock() {
            const now = new Date();
            const hour = now.getHours();
            const min = String(now.getMinutes()).padStart(2, '0');
            const sec = String(now.getSeconds()).padStart(2, '0');
            
            // 更新時間顯示
            document.getElementById('time').innerText = `${hour}:${min}`;
            
            // 檢查是否整點
            if (now.getMinutes() === 0 && now.getSeconds() === 0) {
                announceTime(hour);
            }

            // 防燒屏位移 (每分鐘微調位置)
            const offset = (now.getMinutes() % 2 === 0) ? "2px" : "-2px";
            document.getElementById('clock-container').style.transform = `translate(${offset}, ${offset})`;
        }

        // 定位與天氣邏輯 (簡化版示意)
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    // 這裡應接您的氣象 API
                    document.getElementById('weather').innerText = "台中 多雲 27°C";
                });
            }
        }

        setInterval(updateClock, 1000);
        getLocation();
        document.getElementById('chime-btn').classList.add('active');
    </script>
</body>
</html>
