<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eric's Pro Clock</title>
    <style>
        /* 禁止選取與溢出，保持純黑背景 */
        * { user-select: none; -webkit-tap-highlight-color: transparent; }
        body { 
            background-color: black; 
            color: #FF8C00; 
            font-family: "Noto Sans TC", sans-serif; 
            margin: 0; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            overflow: hidden; 
        }

        /* 上排日期與農曆 */
        #date-lunar { font-size: 5vw; margin-bottom: 10px; white-space: nowrap; }

        /* 中央時鐘區域：穩定排版關鍵 */
        #clock-wrapper { display: flex; align-items: center; justify-content: center; position: relative; }
        #time-hm { font-size: 32vw; font-weight: bold; line-height: 1; letter-spacing: -2px; }
        
        /* 冒號與秒數容器 */
        #colon-sec-container { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 10vw; 
            margin-left: 5px; 
            position: relative;
        }
        #upper-dot { font-size: 15vw; line-height: 0.5; margin-bottom: 6vw; font-weight: bold; }
        #lower-sec { 
            font-size: 13vw; 
            font-weight: bold; 
            line-height: 1; 
            margin-top: -4vw; 
            font-variant-numeric: tabular-nums; /* 防止數字切換時抖動 */
        }

        /* 下排天氣資訊 */
        #weather { font-size: 6.5vw; margin-top: 20px; color: #00FF00; font-weight: bold; }

        /* 報時按鈕：方型 */
        #chime-btn { 
            position: absolute; 
            bottom: 30px; 
            right: 30px; 
            width: 70px; 
            height: 70px; 
            border: 2px solid #FF8C00; 
            border-radius: 12px; 
            background: rgba(255, 140, 0, 0.1); 
            color: #FF8C00; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 16px; 
            font-weight: bold; 
            cursor: pointer; 
            text-align: center;
        }
        #chime-btn.active { background: rgba(255, 140, 0, 0.5); color: white; }
    </style>
</head>
<body onclick="unlockVoice()">

    <div id="date-lunar">正在讀取日期...</div>
    
    <div id="clock-wrapper">
        <div id="time-hm">00:00</div>
        <div id="colon-sec-container">
            <div id="upper-dot">.</div>
            <div id="lower-sec">00</div>
        </div>
    </div>

    <div id="weather">正在獲取 GPS 氣象...</div>

    <div id="chime-btn" class="active" onclick="toggleChime(event)">報時<br>ON</div>

<script>
    let isChimeEnabled = true;
    let voiceReady = false;
    let lastHour = -1;

    // 1. 點擊螢幕解鎖語音權限 (Android APK 必須)
    function unlockVoice() {
        if (!voiceReady) {
            const msg = new SpeechSynthesisUtterance("報時系統已啟動");
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
            voiceReady = true;
        }
    }

    // 2. 報時按鈕開關
    function toggleChime(e) {
        e.stopPropagation();
        isChimeEnabled = !isChimeEnabled;
        const btn = document.getElementById('chime-btn');
        btn.innerHTML = isChimeEnabled ? "報時<br>ON" : "報時<br>OFF";
        btn.classList.toggle('active');
        
        const msg = new SpeechSynthesisUtterance(isChimeEnabled ? "整點報時已開啟" : "整點報時已關閉");
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    // 3. 更新時鐘與農曆 (純中文顯示)
    function updateClock() {
        const now = new Date();
        
        // 日期與農曆
        const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const solar = now.toLocaleDateString('zh-TW', dateOptions);
        const lunarStr = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', {month:'long', day:'numeric'}).format(now);
        document.getElementById('date-lunar').innerText = `${solar} 農曆${lunarStr}`;

        // 時間排版
        const h = now.getHours();
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('time-hm').innerText = `${h}:${m}`;
        document.getElementById('lower-sec').innerText = s;
        
        // 點閃爍 (冒號上點)
        document.getElementById('upper-dot').style.opacity = (now.getSeconds() % 2 === 0) ? "1" : "0.2";

        // 整點報時判斷 (0分0秒)
        if (now.getMinutes() === 0 && now.getSeconds() === 0 && h !== lastHour) {
            if (isChimeEnabled && h >= 7 && h < 23) {
                const weatherText = document.getElementById('weather').innerText;
                const msg = new SpeechSynthesisUtterance(`現在時間${h}點整。${weatherText}`);
                msg.lang = 'zh-TW';
                window.speechSynthesis.speak(msg);
            }
            lastHour = h;
        }
    }

    // 4. 真實 GPS 定位與氣象數據 (含真實濕度)
    async function getGPSWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                try {
                    // 行政區逆地理編碼
                    const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=zh-TW`);
                    const geoData = await geoRes.json();
                    const area = geoData.address.suburb || geoData.address.district || geoData.address.township || "台中";

                    // 真實氣溫與濕度
                    const weatherRes = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code`);
                    const weatherData = await weatherRes.json();
                    
                    const temp = Math.round(weatherData.current.temperature_2m);
                    const humi = weatherData.current.relative_humidity_2m;
                    const code = weatherData.current.weather_code;

                    let status = "晴朗";
                    if (code > 0 && code <= 3) status = "多雲";
                    else if (code >= 45) status = "有雨";

                    document.getElementById('weather').innerText = `${area} ${status} ${temp}°C / 濕度 ${humi}%`;
                } catch(e) {
                    document.getElementById('weather').innerText = "台中 定位獲取中...";
                }
            });
        }
    }

    setInterval(updateClock, 1000);
    setInterval(getGPSWeather, 900000); // 15 分鐘更新一次氣象
    updateClock();
    getGPSWeather();
</script>
</body>
</html>
