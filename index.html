// 1. 改良版語音函數
function speak(text, force = false) {
    if (!voiceEnabled && !force) return;
    if (!text) return;
    
    // 暫停而不是立即取消，避免衝突
    if (synth.speaking) {
        synth.pause();
        synth.cancel(); // 短暫延遲後取消
    }
    
    setTimeout(() => {
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.rate = 0.95;
        utterance.onerror = (e) => console.log('語音錯誤:', e);
        synth.speak(utterance);
    }, 50);
}

// 2. 穩健的農曆顯示
function getLunarText(date) {
    try {
        // 備援方案：使用傳統計算或顯示簡單農曆
        const lunarMonths = ['正月', '二月', '三月', '四月', '五月', '六月', 
                            '七月', '八月', '九月', '十月', '十一月', '十二月'];
        const month = date.getMonth();
        const day = date.getDate();
        
        // 簡易農曆顯示（實際專案應引入農曆庫）
        return `農曆 ${lunarMonths[month]} ${day}`;
    } catch (e) {
        return '農曆日期';
    }
}

// 3. 完整的天氣備援
async function updateWeatherAndAddress(lat, lon) {
    try {
        // ... 原有代碼 ...
    } catch (e) {
        console.error('天氣更新失敗', e);
        document.getElementById('city').innerText = '台中市 北區';
        document.getElementById('weather-detail').innerText = '多雲 24°C / 濕度 65%';
    }
}

// 4. 整點報時防呆
let isUpdatingWeather = false;
if (mm === 0 && ss === 0 && hh !== lastHour) {
    speak(`現在時間 ${hh} 點整`);
    lastHour = hh;
    
    if (!isUpdatingWeather) {
        isUpdatingWeather = true;
        autoLocate().finally(() => {
            isUpdatingWeather = false;
        });
    }
}

// 5. 語音開關改進
function toggleVoice(event) {
    event.stopPropagation();
    voiceEnabled = !voiceEnabled;
    
    if (voiceEnabled) {
        statusDiv.innerText = "開";
        statusDiv.style.color = "#ff9800";
        speak("語音已開啟", true);
    } else {
        statusDiv.innerText = "關";
        statusDiv.style.color = "#888";
        speak("語音已關閉", true);
        // 立即取消所有語音
        synth.cancel();
    }
}
