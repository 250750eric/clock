<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; }
        body { 
            background-color: black; 
            color: #FF8C00; 
            font-family: sans-serif; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            overflow: hidden; 
        }

        /* 使用 vh 確保橫屏時字體不爆框 */
        #date-lunar { font-size: 6vh; margin-bottom: 2vh; }
        
        #clock-container { display: flex; align-items: center; justify-content: center; }
        #time-hm { font-size: 45vh; font-weight: bold; line-height: 1; }
        
        #colon-sec { 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 12vh; 
            margin-left: 2vh; 
        }
        #upper-dot { font-size: 15vh; line-height: 1; transition: opacity 0.1s; }
        #lower-sec { font-size: 18vh; font-weight: bold; line-height: 1; margin-top: -5vh; }

        #weather { font-size: 7vh; margin-top: 3vh; color: #00FF00; font-weight: bold; }

        #chime-btn { 
            position: absolute; bottom: 5vh; right: 5vh; 
            width: 12vh; height: 12vh; 
            border: 2px solid #FF8C00; border-radius: 15%; 
            background: rgba(255, 140, 0, 0.1); color: #FF8C00; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 2.5vh; font-weight: bold; text-align: center;
        }
    </style>
</head>
<body onclick="initAudio()">

    <div id="date-lunar">載入日期中...</div>
    <div id="clock-container">
        <div id="time-hm">00:00</div>
        <div id="colon-sec">
            <div id="upper-dot">.</div>
            <div id="lower-sec">00</div>
        </div>
    </div>
    <div id="weather">定位中...</div>

    <div id="chime-btn" onclick="toggleChime(event)">報時<br>ON</div>

<script>
    let isChimeEnabled = true;
    let audioUnlocked = false;

    function initAudio() {
        if (!audioUnlocked) {
            const msg = new SpeechSynthesisUtterance("報時系統已啟動");
            msg.lang = 'zh-TW';
            window.speechSynthesis.speak(msg);
            audioUnlocked = true;
        }
    }

    function toggleChime(e) {
        e.stopPropagation();
        isChimeEnabled = !isChimeEnabled;
        document.getElementById('chime-btn').innerHTML = isChimeEnabled ? "報時<br>ON" : "報時<br>OFF";
        const msg = new SpeechSynthesisUtterance(isChimeEnabled ? "開啟報時" : "關閉報時");
        msg.lang = 'zh-TW';
        window.speechSynthesis.speak(msg);
    }

    // 真正的農曆中文轉換函式
    function getLunarText(date) {
        const lunarFormatter = new Intl.DateTimeFormat('zh-TW-u-ca-chinese', {month:'long', day:'numeric'});
        let lunar = lunarFormatter.format(date);
        // 確保顯示為 "正月十日" 而不是數字
        return lunar.replace(/(\d+)/g, (n) => {
            const chinese = ["零","一","二","三","四","五","六","七","八","九","十"];
            return n.split('').map(d => chinese[parseInt(d)]).join('');
        });
    }

    function update() {
        const now = new Date();
        
        // 日期與中文農曆
        const solarOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        const solar = now.toLocaleDateString('zh-TW', solarOptions);
        document.getElementById('date-lunar').innerText = `${solar} 農曆${getLunarText(now)}`;

        // 時間與秒數
        const h = now.getHours();
        const m = String(now.getMinutes()).padStart(2, '0');
        const s = String(now.getSeconds()).padStart(2, '0');
        document.getElementById('time-hm').innerText = `${h}:${m}`;
        document.getElementById('lower-sec').innerText = s;
        
        // 點閃爍
        document.getElementById('upper-dot').style.opacity = (now.getSeconds() % 2 === 0) ? "1" : "0.1";

        // 整點報時
        if (now.getMinutes() === 0 && now.getSeconds() === 0) {
            if (isChimeEnabled && h >= 7 && h < 23) {
                const weather = document.getElementById('weather').innerText;
                const msg = new SpeechSynthesisUtterance(`現在時間${h}點整。${weather}`);
                msg.lang = 'zh-TW';
                window.speechSynthesis.speak(msg);
            }
        }
    }

    async function fetchWeather() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const { latitude: lat, longitude: lon } = pos.coords;
                try {
                    const geo = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=zh-TW`).then(r => r.json());
                    const area = geo.address.suburb || geo.address.district || geo.address.city || "台中";
                    
                    const weather = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m`).then(r => r.json());
                    const temp = Math.round(weather.current.temperature_2m);
                    const humi = weather.current.relative_humidity_2m;
                    
                    document.getElementById('weather').innerText = `${area} 晴朗 ${temp}°C / 濕度 ${humi}%`;
                } catch(e) { document.getElementById('weather').innerText = "台中 更新中..."; }
            });
        }
    }

    setInterval(update, 1000);
    setInterval(fetchWeather, 600000);
    update();
    fetchWeather();
</script>
</body>
</html>
