<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GPS Clock Elite - Final Master</title>
    <style>
        :root { --bg-color: #000; --main-color: #fff; --accent-color: #00e5ff; --weather-color: #00ff41; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg-color); color: var(--main-color); font-family: sans-serif; overflow: hidden; }
        
        #main-wrapper { 
            width: 100%; height: 100%; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; transition: transform 0.8s ease-in-out;
        }

        /* æ—¥æœŸå€èˆ‡å¼•å°èª */
        #top-info-area { font-size: 4vh; margin-bottom: 1vh; text-align: center; cursor: pointer; position: relative; }
        #guide-tip { 
            font-size: 1.8vh; color: #888; margin-bottom: 1vh; 
            opacity: 0; transition: opacity 1s; font-weight: normal;
        }
        
        #clock-container { display: flex; align-items: center; font-weight: bold; line-height: 0.9; }
        .time-num { font-size: 42vh; transition: color 0.5s; }
        
        #colon-box { width: 12vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #ampm-indicator { height: 4vh; font-size: 3vh; display: flex; align-items: center; justify-content: center; }
        .dot { width: 1.8vh; height: 1.8vh; background-color: currentColor; border-radius: 50%; }
        #seconds { font-size: 9vh; opacity: 0.6; margin-top: 1vh; font-family: monospace; }
        
        #weather-row { display: flex; gap: 15px; font-size: 5.5vh; margin-top: 3vh; font-weight: bold; }
        #city { color: var(--accent-color); }
        #weather-detail { color: var(--weather-color); }

        .side-btn { 
            position: absolute; bottom: 5vh; width: 85px; height: 85px; 
            border: 1px solid #444; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; background: rgba(0,0,0,0.5); 
            border-radius: 12px; cursor: pointer; z-index: 100;
        }
        #format-toggle { left: 5vw; }
        #voice-toggle { right: 5vw; }
        #overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center; z-index: 9999; color: #fff; font-size: 24px; }

        @media (orientation: portrait) { 
            .time-num { font-size: 28vw; } #top-info-area { font-size: 5.5vw; } 
            #weather-row { font-size: 6.5vw !important; flex-direction: column; align-items: center; gap: 8px !important; } 
            #seconds { font-size: 9vw !important; } #colon-box { width: 15vw; }
        }
    </style>
</head>
<body onclick="unlockAudio()">

    <div id="overlay">ã€ é»æ“Šè¢å¹•é–‹å•Ÿç²¾æº–å ±æ™‚ ã€‘</div>

    <div id="main-wrapper">
        <div id="top-info-area" onclick="changeColor(event)">
            <div id="date-str"></div>
            <div id="lunar-str"></div>
        </div>
        <div id="guide-tip">ğŸ’¡ é»æ“Šä¸Šæ–¹æ—¥æœŸå€åŸŸå¯åˆ‡æ›é…è‰²</div>

        <div id="clock-container">
            <div class="time-num" id="hh">00</div>
            <div id="colon-box">
                <div id="ampm-indicator"><div class="dot"></div></div>
                <div id="seconds">00</div>
            </div>
            <div class="time-num" id="mm">00</div>
        </div>

        <div id="weather-row">
            <div id="city">å®šä½ä¸­...</div>
            <div id="weather-detail">æ•¸æ“šæ›´æ–°ä¸­...</div>
        </div>
    </div>

    <div id="format-toggle" class="side-btn" onclick="toggleFormat(event)">
        <div id="f-status" style="font-size: 22px; color: #00e5ff;">24Håˆ¶</div>
        <div style="font-size: 14px; color: #888;">é€²åˆ¶</div>
    </div>

    <div id="voice-toggle" class="side-btn" onclick="toggleVoice(event)">
        <div id="v-status" style="font-size: 22px; color: #ff9800;">é–‹</div>
        <div style="font-size: 14px; color: #888;">å ±æ™‚</div>
    </div>

    <script>
        let lastHour = -1, lastMinute = -1;
        let voiceEnabled = true, use24Hour = true, isUpdatingWeather = false;
        let colorIdx = 0;
        const colors = ['#ffffff', '#ff9800', '#00e5ff', '#00ff41', '#d500f9'];
        const synth = window.speechSynthesis;

        function unlockAudio() {
            const overlay = document.getElementById('overlay');
            if (overlay.style.display !== 'none') {
                overlay.style.display = 'none';
                speak("ç³»çµ±å•Ÿå‹•", true);
                autoLocate();
                
                // é¡¯ç¤ºæç¤ºï¼Œ5ç§’å¾Œæ¶ˆå¤±
                const tip = document.getElementById('guide-tip');
                tip.style.opacity = '1';
                setTimeout(() => { tip.style.opacity = '0'; }, 5000);
            }
        }

        function changeColor(event) {
            event.stopPropagation();
            colorIdx = (colorIdx + 1) % colors.length;
            document.documentElement.style.setProperty('--main-color', colors[colorIdx]);
            speak("åˆ‡æ›é…è‰²", true);
        }

        function speak(text, force = false) {
            if (!voiceEnabled && !force) return;
            if (!text) return;
            synth.cancel(); 
            setTimeout(() => {
                const u = new SpeechSynthesisUtterance(text);
                u.lang = 'zh-TW';
                u.rate = 0.95;
                synth.speak(u);
            }, 50);
        }

        function toggleFormat(event) {
            event.stopPropagation();
            use24Hour = !use24Hour;
            document.getElementById('f-status').innerText = use24Hour ? "24Håˆ¶" : "12Håˆ¶";
            speak("åˆ‡æ›" + (use24Hour ? "24å°æ™‚" : "12å°æ™‚"), true);
            tick();
        }

        function toggleVoice(event) {
            event.stopPropagation();
            const statusDiv = document.getElementById('v-status');
            if (!voiceEnabled) {
                voiceEnabled = true;
                statusDiv.innerText = "é–‹";
                statusDiv.style.color = "#ff9800";
                speak("å ±æ™‚é–‹å•Ÿ", true);
            } else {
                speak("å ±æ™‚é—œé–‰", true);
                statusDiv.innerText = "é—œ";
                statusDiv.style.color = "#888";
                setTimeout(() => { voiceEnabled = false; synth.cancel(); }, 1200);
            }
        }

        function autoLocate() {
            if (isUpdatingWeather) return;
            isUpdatingWeather = true;
            navigator.geolocation.getCurrentPosition(
                async (p) => { await updateWeather(p.coords.latitude, p.coords.longitude); isUpdatingWeather = false; },
                () => { fetch('https://ipapi.co/json/').then(r => r.json()).then(d => updateWeather(d.latitude, d.longitude)).finally(() => isUpdatingWeather = false); },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        }

        async function updateWeather(lat, lon) {
            try {
                const geo = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=zh`).then(r => r.json());
                document.getElementById('city').innerText = `${geo.city || ""} ${geo.locality || ""}`.trim() || "å°ä¸­å¸‚ åŒ—å€";
                const w = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,weather_code&timezone=auto`).then(r => r.json());
                const map = {0:"æ™´æœ—", 1:"æ™´", 2:"å¤šé›²", 3:"é™°å¤©", 45:"éœ§", 61:"å°é›¨", 95:"é›·é›¨"};
                document.getElementById('weather-detail').innerText = `${map[w.current.weather_code] || "å¤šé›²"} ${Math.round(w.current.temperature_2m)}Â°C / æ¿•åº¦ ${w.current.relative_humidity_2m}%`;
            } catch (e) { document.getElementById('city').innerText = "å°ä¸­å¸‚ åŒ—å€"; }
        }

        function getLunarText(d) {
            try {
                const f = new Intl.DateTimeFormat('zh-u-ca-chinese', {day:'numeric', month:'long'}).format(d);
                const c = ["", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­", "ä¸ƒ", "å…«", "ä¹", "å"];
                return "è¾²æ›† " + f.replace(/\d+/, n => {
                    let v = parseInt(n);
                    return v <= 10 ? "åˆ"+c[v] : v < 20 ? "å"+c[v%10] : v==20 ? "äºŒå" : "å»¿"+c[v%10];
                });
            } catch (e) { return 'è¾²æ›†æ—¥æœŸ'; }
        }

        function tick() {
            const now = new Date();
            let hh = now.getHours(), mm = now.getMinutes(), ss = now.getSeconds();

            // é˜²çƒ™å°ä½ç§»
            if (mm !== lastMinute) {
                const offsetX = Math.floor(Math.random() * 8) - 4; // -4px ~ 4px
                const offsetY = Math.floor(Math.random() * 8) - 4;
                document.getElementById('main-wrapper').style.transform = `translate(${offsetX}px, ${offsetY}px)`;
                lastMinute = mm;
            }

            const indicator = document.getElementById('ampm-indicator');
            if (use24Hour) { indicator.innerHTML = '<div class="dot"></div>'; } 
            else { indicator.innerText = hh >= 12 ? "ä¸‹" : "ä¸Š"; }

            let displayHH = use24Hour ? hh : (hh % 12 || 12);
            document.getElementById('hh').innerText = String(displayHH).padStart(2, '0');
            document.getElementById('mm').innerText = String(mm).padStart(2, '0');
            document.getElementById('seconds').innerText = String(ss).padStart(2, '0');
            
            const weeks = ["æ˜ŸæœŸæ—¥", "æ˜ŸæœŸä¸€", "æ˜ŸæœŸäºŒ", "æ˜ŸæœŸä¸‰", "æ˜ŸæœŸå››", "æ˜ŸæœŸäº”", "æ˜ŸæœŸå…­"];
            document.getElementById('date-str').innerText = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${weeks[now.getDay()]}`;
            document.getElementById('lunar-str').innerText = getLunarText(now);

            if (mm === 0 && ss === 0 && hh !== lastHour) {
                speak(`ç¾åœ¨æ™‚é–“${hh}é»æ•´`);
                lastHour = hh;
                autoLocate();
            }
        }
        setInterval(tick, 1000);
        tick();
    </script>
</body>
</html>
